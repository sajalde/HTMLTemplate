/**
 * Galereya v 0.9.9
 * http://vodkabears.github.com/galereya/
 *
 * Licensed under the MIT license
 * Copyright (c) 2013, VodkaBears
 */
(function(c){c.fn.galereya=function(M){var e=this,r,N,O,y=c([]),k=c([]),m,z,q,s,C,H,t,D=c([]),l=c([]),n=[],p=[],g=[],u=[],P,Q,R,h=0,E=300,S,T,j,v=!1,w,aa=function(){U()},ba=function(a){0===c(a.target).closest(".galereya-cats").length&&k.removeClass("open")},ca=function(a){var b=c(a.target);"SPAN"===a.target.nodeName&&(b=b.parent());b.is(":first-child")||V(b.find("span").text());k.toggleClass("open")},da=function(){e.options.disableSliderOnClick||I(parseInt(this.getAttribute("data-visibleIndex"),10))}, ea=function(){J("next")},fa=function(){J("prev")},ga=function(){K()},ha=function(){w?A():F()},ia=function(a){v&&(37===a.which||39===a.which)&&a.preventDefault()},ja=function(a){if(v)switch(a.which){case 27:K();break;case 37:s.click();break;case 39:q.click()}},L=function(){var a=document.createElement("div").style;return"transition"in a||"WebkitTransition"in a||"MozTransition"in a||"msTransition"in a||"OTransition"in a},W=function(a){a=a.css("transitionDuration")||a.css("webkitTransitionDuration")|| a.css("mozTransitionDuration")||a.css("oTransitionDuration")||a.css("msTransitionDuration")||0;return a=1E3*parseFloat(a)},B=function(a,b){a=a||0;if(!(a>=y.length))if(clearTimeout(T),b&&n[a].category!==b)setTimeout(function(){B(++a,b)},0);else{var d=y[a],f=function(){v?c(this).parent().show():c(this).parent().fadeIn(e.options.cellFadeInSpeed,"linear");T=setTimeout(function(){B(++a,b)},e.options.cellFadeInSpeed/2)};d.complete?f.call(d):c(d).attr("src",d.src).load(f);d=r[a];X(d,g.length);f=g.push(d)- 1;c(d).addClass("visible").attr("data-visibleIndex",f)}},X=function(a,b){var d,c;d=b%h;d=d*E+e.options.spacing*d;b>=h?(c=g[b-h],c=c.offsetTop+c.offsetHeight+e.options.spacing):c=0;a.style.top=c+"px";a.style.left=d+"px"},Y=function(a){a=a||0;a>=r.length&&(a=0);var b=c(r[a]);b.addClass("wave");setTimeout(function(){b.removeClass("wave");Y(++a)},e.options.waveTimeout)},V=function(a){k.empty().prepend('<li class="galereya-cats-item"><span>'+a+"</span></li>");g=[];r.stop(!0,!0).fadeOut(200).removeClass("visible"); a===e.options.noCategoryName?B(0):(k.append('<li class="galereya-cats-item"><span>'+e.options.noCategoryName+"</span></li>"),B(0,a));for(var b=0,c=p.length,f;b<c;b++)f=p[b],f!==a&&k.append('<li class="galereya-cats-item"><span>'+f+"</span></li>")},U=function(){E=r.width();h=Math.floor(e.width()/(E+e.options.spacing));1>h&&(h=1);R=h*E+(h-1)*e.options.spacing;0===l.length&&(l=D.find(".galereya-slide-img"));l.css("margin-top",(c(window).height()-l.height())/2);O.width(R);for(var a=0,b=g.length;a<b;a++)X(g[a], a)},I=function(a){if(v)setTimeout(function(){I(a)},50);else{A();z.empty();j=a;var b=W(m),d=function(){P=c("html").css("overflow");Q=c("body").css("overflow");S=c(window).scrollTop();c("html, body").css("overflow","hidden")};m.show(0,function(){m.addClass("opened");L()?setTimeout(d,b+50):d()});v=!0;J();Z()}},K=function(){if(v){c("html").css("overflow",P);c("body").css("overflow",Q);c(window).scrollTop(S);var a=W(m),b=function(){A();u=[];z.empty();m.hide();v=!1};m.removeClass("opened");L()?setTimeout(b, a+50):b()}},$=function(a){clearInterval(w);a=parseInt(g[a].getAttribute("data-index"),10);var b,d;b=c('<div class="galereya-slider-slide" />').html('<div class="galereya-slide-loader"></div>');d=c('<img class="galereya-slide-img" src="'+n[a].fullsrc+'" alt="'+n[a].title+'" />').load(function(){b.html(d);d.css("margin-top",(c(window).height()-d.height())/2);w&&F()});return b},J=function(a){a=a||"next";w&&(A(),F());var b;a=a.toLowerCase();var d,e=g.length;if("next"===a){if(0===u.length)b=j,a="";else if(b= j+1,b>=e)return;d=u[b];d||(d=$(b),d.addClass(a),z.append(d),u[b]=d);G(d,"current");G(D,"prev")}else if("prev"===a){0!==u.length&&(a="");b=j-1;if(0>b)return;d=u[b];d||(d=$(b),d.addClass(a),z.prepend(d),u[b]=d);G(d,"current");G(D,"next")}j=b;D=d;b=g[j].getAttribute("data-index");C.empty().html('<div class="galereya-slider-desc-title">'+n[b].title+" </div>"+n[b].description);l=d.find(".galereya-slide-img");l.css("margin-top",(c(window).height()-l.height())/2);Z()},G=function(a,b){setTimeout(function(){a.removeClass("prev").removeClass("next").removeClass("current").addClass(b)}, 50)},Z=function(){j>=g.length-1?(A(),t.hide(),q.hide()):(t.show(),q.show());0>=j?s.hide():s.show()},F=function(){t.addClass("pause");w=setInterval(function(){q.click()},e.options.slideShowSpeed)},A=function(){t.removeClass("pause");clearInterval(w);w=null};this.options=c.extend({},{spacing:0,wave:!0,waveTimeout:300,modifier:"",slideShowSpeed:1E4,cellFadeInSpeed:200,noCategoryName:"all",disableSliderOnClick:!1,load:function(a){a()}},M);this.openSlider=I;this.closeSlider=K;this.changeCategory=V;this.startSlideShow= F;this.stopSlideShow=A;this.nextSlide=function(){q.click()};this.prevSlide=function(){s.click()};e.addClass("galereya").addClass(e.options.modifier);var x,y=e.find("img").each(function(a,b){x={lowsrc:b.getAttribute("src")||"",fullsrc:b.getAttribute("data-fullsrc")||"",title:b.getAttribute("title")||b.getAttribute("alt")||"",description:b.getAttribute("data-desc")||"",category:b.getAttribute("data-category")||""};x.category&&(x.category=x.category.toLowerCase(),-1===c.inArray(x.category,p)&&p.push(x.category)); n.push(x)});e.options.load(function(a){for(var b=0,d=a.length,f,g;b<d;b++)f=a[b],f.description=f.description||"",f.title=f.title||"",f.category&&(f.category=f.category.toLowerCase(),-1===c.inArray(f.category,p)&&p.push(f.category)),g=c(document.createElement("img")).attr("src",f.lowsrc),e.append(g),y=y.add(g),n.push(f);if(0<p.length){k=c('<ul class="galereya-cats" />');N=c('<div class="galereya-top" />');e.prepend(N.html(k));k.append('<li class="galereya-cats-item"><span>'+e.options.noCategoryName+ "</span></li>");for(a=0;a<p.length;a++)k.append('<li class="galereya-cats-item"><span>'+p[a]+"</span></li>")}var h,j,l;y.wrapAll('<div class="galereya-grid" />').each(function(a,b){h=c(b);j=n[a].title;l=n[a].description;h.addClass("galereya-cell-img").wrap('<div class="galereya-cell" data-index="'+a+'"></div>').parent().append('<div class="galereya-cell-desc"><div class="galereya-cell-desc-title">'+j+'</div><div class="galereya-cell-desc-text">'+l+"</div></div>").append('<div class="galereya-cell-overlay" />')}); r=e.find(".galereya-cell");O=e.find(".galereya-grid");m=c('<div class="galereya-slider" />');z=c('<div class="galereya-slider-container" />');q=c('<div class="galereya-slider-nav right" />');s=c('<div class="galereya-slider-nav left" />');C=c('<div class="galereya-slider-desc" />');H=c('<div class="galereya-slider-close" />');t=c('<div class="galereya-slider-play" />');m.addClass(e.options.modifier).append(z).append(q).append(s).append(C).append(C).append(H).append(t);c(document.body).append(m);e.show(); U();B();e.options.wave&&L()&&Y();c(window).bind("resize",aa);c(document.body).click(ba).keydown(ia).keyup(ja);k.click(ca);r.click(da);q.click(ea);s.click(fa);H.click(ga);t.click(ha)});1<this.length&&this.each(function(){c(this).galereya(M)});return this}})(jQuery);